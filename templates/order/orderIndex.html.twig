{% extends 'base.html.twig' %}

{% block title %}Commande{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row g-4">

        <!-- Formulaire commande -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-primary text-white rounded-top-4">
                    <h3 class="mb-0">Informations de commande</h3>
                </div>
                <div class="card-body p-4">
                    {{ form_start(form) }}
                        <div class="mb-3">
                            {{ form_widget(form) }}
                        </div>
                        <button type="submit" class="btn btn-primary px-4 py-2 rounded-pill">
                            Continuer
                        </button>
                    {{ form_end(form) }}
                </div>
            </div>
        </div>

        <!-- Résumé commande -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 rounded-4">
                <div class="card-header bg-light rounded-top-4">
                    <h4 class="mb-0 text-primary fw-bold">Résumé de commande</h4>
                </div>
                <div class="card-body p-4">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-medium">Montant des produits :</span>
                        <span class="fw-bold text-dark fs-5">
                            <span id="card-price">{{ total }}</span> €
                        </span>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="fw-medium">Frais de livraison :</span>
                        <span class="fw-bold text-dark fs-5">
                            <span id="shippingCost">0</span> €
                        </span>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-5 text-primary">Montant total :</span>
                        <span class="fw-bold fs-4 text-success">
                            <span class="total_Price">0</span> €
                        </span>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        const citySelector = $('#order_city');
        const cardPrice = parseInt($("#card-price").text());

        function updateShipping(url) {
            $.ajax({
                url: url,
                type: 'GET',
                success: function(response) {
                    const newResponse = JSON.parse(response);
                    if (parseInt(newResponse.status) === 200) {
                        const shippingCost = parseInt(newResponse.content);
                        $("#shippingCost").text(shippingCost);
                        $('.total_Price').text(cardPrice + shippingCost);
                    }
                }
            });
        }

        // Initial request
        updateShipping(`http://localhost:8000/city/${citySelector.val()}/shipping/cost`);

        // On change city
        citySelector.on('change', function() {
            updateShipping(`http://localhost:8000/city/${$(this).val()}/shipping/cost`);
        });
    });
</script>
{% endblock %}
